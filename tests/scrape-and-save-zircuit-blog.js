/**
 * Scrape ALL Zircuit blog posts and save to markdown files
 */

import { webflowScrapeAll } from '../dist/tools.js';
import fs from 'fs';
import path from 'path';

console.log('============================================================');
console.log('  SCRAPING ALL ZIRCUIT BLOG POSTS TO .MD FILES');
console.log('============================================================\n');

// Create output directory with timestamp
const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
const outputDir = path.join(process.cwd(), `zircuit-blog-scraped-${timestamp}`);
if (!fs.existsSync(outputDir)) {
  fs.mkdirSync(outputDir, { recursive: true });
  console.log(`Created output directory: ${outputDir}\n`);
}

console.log('Starting full blog scrape...');
console.log('This will scrape all posts from https://www.zircuit.com/blog\n');

const startTime = Date.now();

const result = await webflowScrapeAll({
  accessToken: 'none',
  url: 'https://www.zircuit.com/blog',
  options: {
    maxPosts: 100,         // Scrape up to 100 posts
    includeMetadata: true,
    includeImages: true,
    concurrency: 3         // 3 concurrent requests
  }
});

const duration = Date.now() - startTime;

if (!result.success) {
  console.error('âŒ Scraping failed:', result.error);
  process.exit(1);
}

console.log(`âœ… Scraping complete! (${duration}ms / ${(duration/1000).toFixed(1)}s)\n`);
console.log(`ğŸ“Š Statistics:`);
console.log(`   Posts discovered: ${result.data.metadata.discoveredPosts}`);
console.log(`   Posts scraped: ${result.data.totalPosts}`);
console.log(`   Total characters: ${result.data.totalCharacters.toLocaleString()}`);
console.log(`   Average post size: ${Math.round(result.data.totalCharacters / result.data.totalPosts)} chars\n`);

console.log('ğŸ’¾ Saving markdown files...\n');

// Save each post as a markdown file
let savedCount = 0;
result.data.posts.forEach((post, index) => {
  try {
    // Create a safe filename from the URL
    const url = new URL(post.url);
    let filename = url.pathname
      .replace(/^\/(en\/)?blog\//, '')  // Remove /blog/ or /en/blog/
      .replace(/\//g, '_')
      .replace(/[^a-zA-Z0-9_-]/g, '')
      || 'index';

    // Ensure it ends with .md
    if (!filename.endsWith('.md')) {
      filename += '.md';
    }

    const filepath = path.join(outputDir, filename);

    // Create markdown content with frontmatter
    const frontmatter = {
      url: post.url,
      title: post.metadata.title || 'Untitled',
      scraped: new Date().toISOString()
    };

    // Add optional metadata
    if (post.metadata.author) {
      frontmatter.author = post.metadata.author;
    }
    if (post.metadata.publishedDate) {
      frontmatter.publishedDate = post.metadata.publishedDate;
    }
    if (post.metadata.categories && post.metadata.categories.length > 0) {
      frontmatter.categories = post.metadata.categories.join(', ');
    }

    const frontmatterStr = Object.entries(frontmatter)
      .map(([key, value]) => `${key}: ${value}`)
      .join('\n');

    const content = `---
${frontmatterStr}
---

# ${post.metadata.title || 'Untitled'}

**Source:** ${post.url}

---

${post.markdown}
`;

    fs.writeFileSync(filepath, content, 'utf-8');
    savedCount++;

    console.log(`   ${index + 1}. ${filename}`);
    console.log(`      Title: ${post.metadata.title}`);
    console.log(`      URL: ${post.url}`);
    console.log(`      Size: ${post.markdown.length} chars`);
    if (post.metadata.publishedDate) {
      console.log(`      Published: ${post.metadata.publishedDate}`);
    }
    if (post.metadata.author) {
      console.log(`      Author: ${post.metadata.author}`);
    }
  } catch (error) {
    console.error(`   âŒ Error saving ${post.url}:`, error.message);
  }
});

console.log(`\nâœ… Saved ${savedCount} markdown files to: ${outputDir}\n`);

// Create an index file
const indexContent = `# Zircuit Blog - Scraped Index

**Scraped:** ${new Date().toISOString()}
**Total Posts:** ${result.data.totalPosts}
**Total Content:** ${result.data.totalCharacters.toLocaleString()} characters
**Source:** https://www.zircuit.com/blog

---

## All Blog Posts

${result.data.posts.map((post, i) => {
  const url = new URL(post.url);
  const filename = (url.pathname
    .replace(/^\/(en\/)?blog\//, '')
    .replace(/\//g, '_')
    .replace(/[^a-zA-Z0-9_-]/g, '')
    || 'index') + '.md';

  let entry = `${i + 1}. [${post.metadata.title || 'Untitled'}](./${filename})`;

  if (post.metadata.publishedDate) {
    entry += `\n   - Published: ${post.metadata.publishedDate}`;
  }
  if (post.metadata.author) {
    entry += `\n   - Author: ${post.metadata.author}`;
  }
  entry += `\n   - URL: ${post.url}`;
  entry += `\n   - Size: ${post.markdown.length} chars`;

  return entry;
}).join('\n\n')}

---

**Generated by ZeekeeWebflow MCP Server**
**Repository:** https://github.com/oregpt/Agenticledger_MCP_ZeekeeWebflow
`;

const indexPath = path.join(outputDir, 'INDEX.md');
fs.writeFileSync(indexPath, indexContent, 'utf-8');
console.log(`ğŸ“„ Created index file: INDEX.md\n`);

console.log('============================================================');
console.log('  SCRAPING COMPLETE');
console.log('============================================================\n');
console.log(`ğŸ“ All files saved to: ${outputDir}`);
console.log(`ğŸ“– Open INDEX.md to see all posts`);
console.log(`\nğŸ‰ Successfully scraped ${savedCount} blog posts!\n`);
